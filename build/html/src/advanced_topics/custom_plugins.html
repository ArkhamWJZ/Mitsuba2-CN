<!-- Based on https://stackoverflow.com/a/25543713/1130282 -->

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../../_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="../../_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>Custom plugins in Python &#8212; mitsuba2 0.1.dev0 documentation</title>
    <link rel="stylesheet" href="../../_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/theme_overrides.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Plugin reference" href="../plugin_reference/intro.html" />
    <link rel="prev" title="Polarization" href="../developer_guide/polarization.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../plugin_reference/intro.html" title="Plugin reference"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../developer_guide/polarization.html" title="Polarization"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">mitsuba2 0.1.dev0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Custom plugins in Python</a></li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar"><a href="
    ../../index.html" class="text-logo">Mitsuba 2</a>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Table Of Contents</h2>
  </div>
  <div class="sidebar-toc">
    
    
      <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/intro.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/cloning.html">Cloning the repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/variants.html">Choosing variants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/compiling.html">Compiling the system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/file_format.html">Scene file format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/differences.html">Differences to Mitsuba 0.6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/faq.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">Release notes</a></li>
</ul>
<p class="caption"><span class="caption-text">Python interface</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python_interface/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_interface/parsing_xml.html">Parsing XML code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_interface/rendering_scene.html">Rendering a scene</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_interface/bsdf_eval.html">Custom applications</a></li>
</ul>
<p class="caption"><span class="caption-text">Inverse rendering</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../inverse_rendering/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inverse_rendering/diff_render.html">Differentiable rendering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inverse_rendering/advanced.html">More advanced examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inverse_rendering/pytorch.html">Integration with PyTorch</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/variants_cpp.html">Variants in C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/writing_plugin.html">Plugins &amp; Macros</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/building_documentation.html">Building the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/polarization.html">Polarization</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced topics</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Custom plugins in Python</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#bsdf-example">BSDF example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#integrator-example">Integrator example</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Plugin reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../plugin_reference/intro.html">Plugin reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html">Shapes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#bsdfs">BSDFs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#phase-functions">Phase functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#emitters">Emitters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#sensors">Sensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#textures">Textures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#spectra">Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#integrators">Integrators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#samplers">Samplers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#films">Films</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#reconstruction-filters">Reconstruction filters</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/core_api.html">Core API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/render_api.html">Render API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/python_api.html">Python API Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../zz_bibliography.html">Bibliography</a></li>
</ul>

    
  </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="../../index.html">Docs</a></li>
              
              <li>Custom plugins in Python</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <div class="section" id="custom-plugins-in-python">
<span id="sec-custom-plugins"></span><h1>Custom plugins in Python<a class="headerlink" href="#custom-plugins-in-python" title="Permalink to this headline">¶</a></h1>
<p>Mitsuba 2 provides a mechanism to implement custom plugins <em>directly in
Python</em>. To do so, simply extend a base class (e.g. <code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">BSDF</span></code>, <code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">Emitter</span></code>) and
override its class methods (e.g. <code class="docutils literal notranslate"><span class="pre">sample()</span></code>, <code class="docutils literal notranslate"><span class="pre">eval()</span></code>, …). This leverages
the <a class="reference external" href="https://pybind11.readthedocs.io/en/stable/advanced/classes.html#overriding-virtual-functions-in-python">trampoline feature</a>
of <em>pybind11</em>.</p>
<p>The new plugin can then be registered with the XML parser by calling one of
several <code class="docutils literal notranslate"><span class="pre">register_&lt;type&gt;(name,</span> <span class="pre">constructor)</span></code> functions, making it accessible
in the XML scene language like any other C++ plugin.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Only <code class="docutils literal notranslate"><span class="pre">gpu_*</span></code> variants will produce reasonable performance
when using such Python implementations of core system components (since
they can be JIT-compiled along with other system components). We plan to
extend this feature to further variant types in the future.</p>
<p>Furthermore, only <code class="docutils literal notranslate"><span class="pre">BSDF</span></code>, <code class="docutils literal notranslate"><span class="pre">Emitter</span></code>, and <code class="docutils literal notranslate"><span class="pre">Integrator</span></code> plugins can
currently be implemented in Python.</p>
</div>
<p>The remainder of this section discusses several examples.</p>
<div class="section" id="bsdf-example">
<h2>BSDF example<a class="headerlink" href="#bsdf-example" title="Permalink to this headline">¶</a></h2>
<p>In this example, we will implement a simple diffuse BSDF in Python by extending
the <code class="code docutils literal notranslate"><span class="pre">BSDF</span></code> base class. The code is very similar to the diffuse BSDF
implemented in C++ (in <code class="code docutils literal notranslate"><span class="pre">src/bsdf/diffuse.cpp</span></code>).</p>
<p>The BSDF class need to implement the following 3 methods: <code class="code docutils literal notranslate"><span class="pre">sample</span></code>,
<code class="code docutils literal notranslate"><span class="pre">eval</span></code> and <code class="code docutils literal notranslate"><span class="pre">pdf</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyDiffuseBSDF</span><span class="p">(</span><span class="n">BSDF</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">):</span>
        <span class="n">BSDF</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_reflectance</span> \
            <span class="o">=</span> <span class="n">load_string</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;&lt;spectrum version=&#39;2.0.0&#39; type=&#39;srgb&#39; name=&quot;reflectance&quot;&gt;</span>
<span class="s1">                                &lt;rgb name=&quot;color&quot; value=&quot;0.45, 0.90, 0.90&quot;/&gt;</span>
<span class="s1">                             &lt;/spectrum&gt;&#39;&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_flags</span> <span class="o">=</span> <span class="n">BSDFFlags</span><span class="o">.</span><span class="n">DiffuseReflection</span> <span class="o">|</span> <span class="n">BSDFFlags</span><span class="o">.</span><span class="n">FrontSide</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_components</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">m_flags</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">sample1</span><span class="p">,</span> <span class="n">sample2</span><span class="p">,</span> <span class="n">active</span><span class="p">):</span>
        <span class="n">cos_theta_i</span> <span class="o">=</span> <span class="n">Frame3f</span><span class="o">.</span><span class="n">cos_theta</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span>

        <span class="n">active</span> <span class="o">&amp;=</span> <span class="n">cos_theta_i</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="n">bs</span> <span class="o">=</span> <span class="n">BSDFSample3f</span><span class="p">()</span>
        <span class="n">bs</span><span class="o">.</span><span class="n">wo</span>  <span class="o">=</span> <span class="n">warp</span><span class="o">.</span><span class="n">square_to_cosine_hemisphere</span><span class="p">(</span><span class="n">sample2</span><span class="p">)</span>
        <span class="n">bs</span><span class="o">.</span><span class="n">pdf</span> <span class="o">=</span> <span class="n">warp</span><span class="o">.</span><span class="n">square_to_cosine_hemisphere_pdf</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">wo</span><span class="p">)</span>
        <span class="n">bs</span><span class="o">.</span><span class="n">eta</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">bs</span><span class="o">.</span><span class="n">sampled_type</span> <span class="o">=</span> <span class="o">+</span><span class="n">BSDFFlags</span><span class="o">.</span><span class="n">DiffuseReflection</span>
        <span class="n">bs</span><span class="o">.</span><span class="n">sampled_component</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_reflectance</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">active</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span> <span class="n">bs</span><span class="p">,</span> <span class="n">ek</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">active</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">pdf</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">value</span><span class="p">,</span> <span class="n">Vector3f</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">wo</span><span class="p">,</span> <span class="n">active</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ctx</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">(</span><span class="n">BSDFFlags</span><span class="o">.</span><span class="n">DiffuseReflection</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Vector3f</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">cos_theta_i</span> <span class="o">=</span> <span class="n">Frame3f</span><span class="o">.</span><span class="n">cos_theta</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span>
        <span class="n">cos_theta_o</span> <span class="o">=</span> <span class="n">Frame3f</span><span class="o">.</span><span class="n">cos_theta</span><span class="p">(</span><span class="n">wo</span><span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_reflectance</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">active</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">InvPi</span> <span class="o">*</span> <span class="n">cos_theta_o</span>

        <span class="k">return</span> <span class="n">ek</span><span class="o">.</span><span class="n">select</span><span class="p">((</span><span class="n">cos_theta_i</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cos_theta_o</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">value</span><span class="p">,</span> <span class="n">Vector3f</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">wo</span><span class="p">,</span> <span class="n">active</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ctx</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">(</span><span class="n">BSDFFlags</span><span class="o">.</span><span class="n">DiffuseReflection</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Vector3f</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">cos_theta_i</span> <span class="o">=</span> <span class="n">Frame3f</span><span class="o">.</span><span class="n">cos_theta</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span>
        <span class="n">cos_theta_o</span> <span class="o">=</span> <span class="n">Frame3f</span><span class="o">.</span><span class="n">cos_theta</span><span class="p">(</span><span class="n">wo</span><span class="p">)</span>

        <span class="n">pdf</span> <span class="o">=</span> <span class="n">warp</span><span class="o">.</span><span class="n">square_to_cosine_hemisphere_pdf</span><span class="p">(</span><span class="n">wo</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ek</span><span class="o">.</span><span class="n">select</span><span class="p">((</span><span class="n">cos_theta_i</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cos_theta_o</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">pdf</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;MyDiffuseBSDF[reflectance = </span><span class="si">%s</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m_reflectance</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

</pre></div>
</div>
<p>After defining this new BSDF class, we have to register it as a plugin.
This allows Mitsuba to instantiate this new BSDF when loading a scene:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">register_bsdf</span><span class="p">(</span><span class="s2">&quot;mydiffusebsdf&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">props</span><span class="p">:</span> <span class="n">MyDiffuseBSDF</span><span class="p">(</span><span class="n">props</span><span class="p">))</span>
</pre></div>
</div>
<p>The <code class="code docutils literal notranslate"><span class="pre">register_bsdf</span></code> function takes the name of our new plugin and a function to construct new
instances. After that, we can use our new BSDF in a XML scene file by specifying</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bsdf</span> <span class="na">type=</span><span class="s">&quot;mydiffusebsdf&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<p>The scene can then rendered by calling the standard <code class="code docutils literal notranslate"><span class="pre">render</span></code> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load an XML file which specifies &quot;mydiffusebsdf&quot; as material</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;path/to/my/scene.xml&#39;</span>
<span class="n">Thread</span><span class="o">.</span><span class="n">thread</span><span class="p">()</span><span class="o">.</span><span class="n">file_resolver</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
<span class="n">scene</span> <span class="o">=</span> <span class="n">load_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="n">scene</span><span class="o">.</span><span class="n">integrator</span><span class="p">()</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">scene</span><span class="o">.</span><span class="n">sensors</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">film</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">sensors</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">film</span><span class="p">()</span>
<span class="n">film</span><span class="o">.</span><span class="n">set_destination_file</span><span class="p">(</span><span class="s1">&#39;my-diffuse-bsdf.exr&#39;</span><span class="p">)</span>
<span class="n">film</span><span class="o">.</span><span class="n">develop</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The code for this example can be found in <code class="code docutils literal notranslate"><span class="pre">docs/examples/04_diffuse_bsdf/diffuse_bsdf.py</span></code></p>
</div>
</div>
<div class="section" id="integrator-example">
<h2>Integrator example<a class="headerlink" href="#integrator-example" title="Permalink to this headline">¶</a></h2>
<p>In this example, we will implement custom direct illumination integrator using the same mechanism.
The resulting image will have realistic shadows and shading, but no global illumination.</p>
<p>The main rendering routing can be implemented in around 30 lines of code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">integrator_sample</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="n">rays</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">si</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">ray_intersect</span><span class="p">(</span><span class="n">rays</span><span class="p">)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">active</span>

    <span class="c1"># Visible emitters</span>
    <span class="n">emitter_vis</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">emitter</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">active</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">ek</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">Emitter</span><span class="o">.</span><span class="n">eval_vec</span><span class="p">(</span><span class="n">emitter_vis</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">active</span><span class="p">),</span> <span class="n">Vector3f</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">BSDFContext</span><span class="p">()</span>
    <span class="n">bsdf</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">bsdf</span><span class="p">(</span><span class="n">rays</span><span class="p">)</span>

    <span class="c1"># Emitter sampling</span>
    <span class="n">sample_emitter</span> <span class="o">=</span> <span class="n">active</span> <span class="o">&amp;</span> <span class="n">has_flag</span><span class="p">(</span><span class="n">BSDF</span><span class="o">.</span><span class="n">flags_vec</span><span class="p">(</span><span class="n">bsdf</span><span class="p">),</span> <span class="n">BSDFFlags</span><span class="o">.</span><span class="n">Smooth</span><span class="p">)</span>
    <span class="n">ds</span><span class="p">,</span> <span class="n">emitter_val</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">sample_emitter_direction</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">sampler</span><span class="o">.</span><span class="n">next_2d</span><span class="p">(</span><span class="n">sample_emitter</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">sample_emitter</span><span class="p">)</span>
    <span class="n">active_e</span> <span class="o">=</span> <span class="n">sample_emitter</span> <span class="o">&amp;</span> <span class="n">ek</span><span class="o">.</span><span class="n">neq</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">pdf</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">wo</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">to_local</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
    <span class="n">bsdf_val</span> <span class="o">=</span> <span class="n">BSDF</span><span class="o">.</span><span class="n">eval_vec</span><span class="p">(</span><span class="n">bsdf</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">wo</span><span class="p">,</span> <span class="n">active_e</span><span class="p">)</span>
    <span class="n">bsdf_pdf</span> <span class="o">=</span> <span class="n">BSDF</span><span class="o">.</span><span class="n">pdf_vec</span><span class="p">(</span><span class="n">bsdf</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">wo</span><span class="p">,</span> <span class="n">active_e</span><span class="p">)</span>
    <span class="n">mis</span> <span class="o">=</span> <span class="n">ek</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="n">Float</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">mis_weight</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">pdf</span><span class="p">,</span> <span class="n">bsdf_pdf</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">+=</span> <span class="n">ek</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">active_e</span><span class="p">,</span> <span class="n">emitter_val</span> <span class="o">*</span> <span class="n">bsdf_val</span> <span class="o">*</span> <span class="n">mis</span><span class="p">,</span> <span class="n">Vector3f</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="c1"># BSDF sampling</span>
    <span class="n">active_b</span> <span class="o">=</span> <span class="n">active</span>
    <span class="n">bs</span><span class="p">,</span> <span class="n">bsdf_val</span> <span class="o">=</span> <span class="n">BSDF</span><span class="o">.</span><span class="n">sample_vec</span><span class="p">(</span><span class="n">bsdf</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">sampler</span><span class="o">.</span><span class="n">next_1d</span><span class="p">(</span><span class="n">active</span><span class="p">),</span> <span class="n">sampler</span><span class="o">.</span><span class="n">next_2d</span><span class="p">(</span><span class="n">active</span><span class="p">),</span> <span class="n">active_b</span><span class="p">)</span>
    <span class="n">si_bsdf</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">ray_intersect</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">spawn_ray</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">to_world</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">wo</span><span class="p">)),</span> <span class="n">active_b</span><span class="p">)</span>
    <span class="n">emitter</span> <span class="o">=</span> <span class="n">si_bsdf</span><span class="o">.</span><span class="n">emitter</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">active_b</span><span class="p">)</span>
    <span class="n">active_b</span> <span class="o">&amp;=</span> <span class="n">ek</span><span class="o">.</span><span class="n">neq</span><span class="p">(</span><span class="n">emitter</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">emitter_val</span> <span class="o">=</span> <span class="n">Emitter</span><span class="o">.</span><span class="n">eval_vec</span><span class="p">(</span><span class="n">emitter</span><span class="p">,</span> <span class="n">si_bsdf</span><span class="p">,</span> <span class="n">active_b</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">has_flag</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">sampled_type</span><span class="p">,</span> <span class="n">BSDFFlags</span><span class="o">.</span><span class="n">Delta</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">DirectionSample3f</span><span class="p">(</span><span class="n">si_bsdf</span><span class="p">,</span> <span class="n">si</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">object</span> <span class="o">=</span> <span class="n">emitter</span>
    <span class="n">emitter_pdf</span> <span class="o">=</span> <span class="n">ek</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">Float</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">scene</span><span class="o">.</span><span class="n">pdf_emitter_direction</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">active_b</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">+=</span> <span class="n">ek</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">active_b</span><span class="p">,</span> <span class="n">bsdf_val</span> <span class="o">*</span> <span class="n">emitter_val</span> <span class="o">*</span> <span class="n">mis_weight</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">pdf</span><span class="p">,</span> <span class="n">emitter_pdf</span><span class="p">),</span> <span class="n">Vector3f</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">si</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(),</span> <span class="n">ek</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(),</span> <span class="n">si</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">Float</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
</pre></div>
</div>
<p>The code is very similar to the direct illumination integrator implemented in C++
(in <code class="code docutils literal notranslate"><span class="pre">src/integrators/direct.cpp</span></code>).
The function takes the current scene, sampler and array of rays as arguments.
The <code class="code docutils literal notranslate"><span class="pre">active</span></code> argument specifies which lanes are active.</p>
<p>We first intersect the provided rays against the scene and evaluate the
radiance of directly visible emitters. Then, we explicitly sample positions on
emitters and evaluate their contributions. Additionally, we sample a ray
direction according to the BSDF and evaluate whether these rays also hit some
emitters. These different contributions are then combined using multiple
importance sampling to reduce variance.</p>
<p>This function will be invoked for an array of different rays, hence each ray
can then potentially hit a surface with a different BSDF. Therefore,
<code class="code docutils literal notranslate"><span class="pre">bsdf</span> <span class="pre">=</span> <span class="pre">si.bsdf(rays)</span></code> will be an array of different BSDF pointers. To
then call member functions of these different BSDFs, we invoke special dispatch
functions for vectorized method calls:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">bsdf_val</span> <span class="o">=</span> <span class="n">BSDF</span><span class="o">.</span><span class="n">eval_vec</span><span class="p">(</span><span class="n">bsdf</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">wo</span><span class="p">,</span> <span class="n">active_e</span><span class="p">)</span>
    <span class="n">bsdf_pdf</span> <span class="o">=</span> <span class="n">BSDF</span><span class="o">.</span><span class="n">pdf_vec</span><span class="p">(</span><span class="n">bsdf</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">wo</span><span class="p">,</span> <span class="n">active_e</span><span class="p">)</span>
</pre></div>
</div>
<p>This will ensure that the C++ or Python implementation of the right BSDF model
is invoked for each variant. Other than that, the code and used interfaces are
nearly identical to the C++ version. Please refer to the documentation of the
C++ types for details on the different functions and objects.</p>
<p>When implementing the depth integrator in the section on
<a class="reference internal" href="../python_interface/rendering_scene.html#sec-rendering-scene-custom"><span class="std std-ref">custom rendering pipelines</span></a>, considerable work was
necessary to correctly sample rays from the camera and splat samples into the film.
While this can be very useful for certain applications, it is also a bit tedious.
In many cases, we simply want to implement a custom integrator and not bother with how camera rays are exactly generated.
In this example, we will therefore use a more elegant mechanism, which allows to simply extend the <code class="code docutils literal notranslate"><span class="pre">SamplingIntegrator</span></code> base class.
This class is the base class of all Monte Carlo integrators, e.g. the path tracer.
By using this class to define our integrator, we can then rely on the existing machinery in Mitsuba to correctly sample camera rays and splat pixel values.</p>
<p>Since we already defined a function <code class="code docutils literal notranslate"><span class="pre">integrator_sample</span></code> with the right interface, defining a new integrator becomes very simple:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyDirectIntegrator</span><span class="p">(</span><span class="n">SamplingIntegrator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">):</span>
        <span class="n">SamplingIntegrator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">active</span><span class="p">):</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">is_valid</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">integrator_sample</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">active</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">is_valid</span><span class="p">,</span> <span class="p">[</span><span class="n">depth</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">aov_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;depth.Y&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;MyDirectIntegrator[]&quot;</span>
</pre></div>
</div>
<p>This integrator not only returns the color, but also additionally renders out the depth of the scene.
When using this integrator, Mitsuba will output a multichannel EXR file with a separate depth channel.
The method <code class="code docutils literal notranslate"><span class="pre">aov_names</span></code> is used to name the different arbitrary output variables (AOVs).
The same mechanism could be used to output for example surface normals.
If no AOVs are needed, you can just return an empty list instead.</p>
<p>After defining this new integrator class, we have to register it as a plugin.
This allows Mitsuba to instantiate this new integrator when loading a scene:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">register_integrator</span><span class="p">(</span><span class="s2">&quot;mydirectintegrator&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">props</span><span class="p">:</span> <span class="n">MyDirectIntegrator</span><span class="p">(</span><span class="n">props</span><span class="p">))</span>
</pre></div>
</div>
<p>The <code class="code docutils literal notranslate"><span class="pre">register_integrator</span></code> function takes the name of our new plugin and a function to construct new instances.
After that, we can use our new integrator in a scene by specifying</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;integrator</span> <span class="na">type=</span><span class="s">&quot;mydirectintegrator&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<p>The scene is then rendered by calling the standard <code class="code docutils literal notranslate"><span class="pre">render</span></code> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load an XML file which specifies &quot;mydirectintegrator&quot; as the scene&#39;s integrator</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;path/to/my/scene.xml&#39;</span>
<span class="n">Thread</span><span class="o">.</span><span class="n">thread</span><span class="p">()</span><span class="o">.</span><span class="n">file_resolver</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
<span class="n">scene</span> <span class="o">=</span> <span class="n">load_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="n">scene</span><span class="o">.</span><span class="n">integrator</span><span class="p">()</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">scene</span><span class="o">.</span><span class="n">sensors</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">film</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">sensors</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">film</span><span class="p">()</span>
<span class="n">film</span><span class="o">.</span><span class="n">set_destination_file</span><span class="p">(</span><span class="s1">&#39;my-direct-integrator.exr&#39;</span><span class="p">)</span>
<span class="n">film</span><span class="o">.</span><span class="n">develop</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The code for this example can be found in <code class="code docutils literal notranslate"><span class="pre">docs/examples/03_direct_integrator/direct_integrator.py</span></code></p>
</div>
</div>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="../developer_guide/polarization.html" title="previous chapter (use the left arrow)">Polarization</a>
      </div>
    
      <div class="pull-right">
        <a class="btn btn-default" href="../plugin_reference/intro.html" title="next chapter (use the right arrow)">Plugin reference</a>
      </div>
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../plugin_reference/intro.html" title="Plugin reference"
             >next</a> |</li>
        <li class="right" >
          <a href="../developer_guide/polarization.html" title="Polarization"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">mitsuba2 0.1.dev0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Custom plugins in Python</a></li> 
      </ul>
    </div>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>

  </body>
</html>