<!-- Based on https://stackoverflow.com/a/25543713/1130282 -->

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../../_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="../../_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>Integration with PyTorch &#8212; mitsuba2 0.1.dev0 documentation</title>
    <link rel="stylesheet" href="../../_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/theme_overrides.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Introduction" href="../developer_guide/intro.html" />
    <link rel="prev" title="More advanced examples" href="advanced.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../developer_guide/intro.html" title="Introduction"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="advanced.html" title="More advanced examples"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">mitsuba2 0.1.dev0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Integration with PyTorch</a></li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar"><a href="
    ../../index.html" class="text-logo">Mitsuba 2</a>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Table Of Contents</h2>
  </div>
  <div class="sidebar-toc">
    
    
      <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/intro.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/cloning.html">Cloning the repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/variants.html">选择变体</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/compiling.html">Compiling the system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/file_format.html">Scene file format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/differences.html">Differences to Mitsuba 0.6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/faq.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">Release notes</a></li>
</ul>
<p class="caption"><span class="caption-text">Python interface</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python_interface/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_interface/parsing_xml.html">Parsing XML code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_interface/rendering_scene.html">Rendering a scene</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_interface/bsdf_eval.html">Custom applications</a></li>
</ul>
<p class="caption"><span class="caption-text">Inverse rendering</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="diff_render.html">Differentiable rendering</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced.html">More advanced examples</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Integration with PyTorch</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/variants_cpp.html">Variants in C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/writing_plugin.html">Plugins &amp; Macros</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/building_documentation.html">Building the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/polarization.html">Polarization</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../advanced_topics/custom_plugins.html">Custom plugins in Python</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugin reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../plugin_reference/intro.html">Plugin reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html">Shapes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#bsdfs">BSDFs 大大大</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#phase-functions">Phase functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#emitters">Emitters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#sensors">Sensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#textures">Textures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#spectra">Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#integrators">Integrators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#samplers">Samplers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#films">Films</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#reconstruction-filters">Reconstruction filters</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/core_api.html">Core API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/render_api.html">Render API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/python_api.html">Python API Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../zz_bibliography.html">Bibliography</a></li>
</ul>

    
  </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="../../index.html">Docs</a></li>
              
              <li>Integration with PyTorch</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <div class="section" id="integration-with-pytorch">
<span id="sec-pytorch"></span><h1>Integration with PyTorch<a class="headerlink" href="#integration-with-pytorch" title="Permalink to this headline">¶</a></h1>
<p>We briefly show how the example from the earlier section on
<a class="reference internal" href="diff_render.html#sec-differentiable-rendering"><span class="std std-ref">differentiable rendering</span></a> can be made to
work when combining differentiable rendering with an optimization expressed
using PyTorch. The ability to combine these frameworks enables sandwiching
Mitsuba 2 between neural layers and differentiating the combination end-to-end.</p>
<p>Note that communication and synchronization between Enoki and PyTorch along
with the complexity of traversing two separate computation graph data
structures causes an overhead of 10-20% compared to optimization implemented
using only Enoki. We generally recommend sticking with Enoki unless the problem
requires neural network building blocks like fully connected layers or
convolutions, where PyTorch provides a clear advantage.</p>
<p>As before, we specify the relevant variant, load the scene, and retain
relevant differentiable parameters.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mitsuba</span>
<span class="n">mitsuba</span><span class="o">.</span><span class="n">set_variant</span><span class="p">(</span><span class="s1">&#39;gpu_autodiff_rgb&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">enoki</span> <span class="k">as</span> <span class="nn">ek</span>
<span class="kn">from</span> <span class="nn">mitsuba.core</span> <span class="kn">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">Vector3f</span>
<span class="kn">from</span> <span class="nn">mitsuba.core.xml</span> <span class="kn">import</span> <span class="n">load_file</span>
<span class="kn">from</span> <span class="nn">mitsuba.python.util</span> <span class="kn">import</span> <span class="n">traverse</span>
<span class="kn">from</span> <span class="nn">mitsuba.python.autodiff</span> <span class="kn">import</span> <span class="n">render_torch</span><span class="p">,</span> <span class="n">write_bitmap</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">Thread</span><span class="o">.</span><span class="n">thread</span><span class="p">()</span><span class="o">.</span><span class="n">file_resolver</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cbox&#39;</span><span class="p">)</span>
<span class="n">scene</span> <span class="o">=</span> <span class="n">load_file</span><span class="p">(</span><span class="s1">&#39;cbox/cbox.xml&#39;</span><span class="p">)</span>

<span class="c1"># Find differentiable scene parameters</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">traverse</span><span class="p">(</span><span class="n">scene</span><span class="p">)</span>

<span class="c1"># Discard all parameters except for one we want to differentiate</span>
<span class="n">params</span><span class="o">.</span><span class="n">keep</span><span class="p">([</span><span class="s1">&#39;red.reflectance.value&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.torch()</span></code> method can be used to convert any Enoki CUDA type
into a corresponding PyTorch tensor.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print the current value and keep a backup copy</span>
<span class="n">param_ref</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;red.reflectance.value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">torch</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">param_ref</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="../../generated/python_api.html#mitsuba.python.autodiff.render_torch" title="mitsuba.python.autodiff.render_torch"><code class="xref py py-func docutils literal notranslate"><span class="pre">render_torch()</span></code></a> function works
analogously to <a class="reference internal" href="../../generated/python_api.html#mitsuba.python.autodiff.render" title="mitsuba.python.autodiff.render"><code class="xref py py-func docutils literal notranslate"><span class="pre">render()</span></code></a> except that it
returns a PyTorch tensor.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Render a reference image (no derivatives used yet)</span>
<span class="n">image_ref</span> <span class="o">=</span> <span class="n">render_torch</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">spp</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">crop_size</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">sensors</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">film</span><span class="p">()</span><span class="o">.</span><span class="n">crop_size</span><span class="p">()</span>
<span class="n">write_bitmap</span><span class="p">(</span><span class="s1">&#39;out.png&#39;</span><span class="p">,</span> <span class="n">image_ref</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">)</span>
</pre></div>
</div>
<p>As before, we change one of the input parameters and initialize an optimizer.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Change the left wall into a bright white surface</span>
<span class="n">params</span><span class="p">[</span><span class="s1">&#39;red.reflectance.value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">.</span><span class="mi">9</span><span class="p">,</span> <span class="o">.</span><span class="mi">9</span><span class="p">,</span> <span class="o">.</span><span class="mi">9</span><span class="p">]</span>
<span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

<span class="c1"># Which parameters should be exposed to the PyTorch optimizer?</span>
<span class="n">params_torch</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">torch</span><span class="p">()</span>

<span class="c1"># Construct a PyTorch Adam optimizer that will adjust &#39;params_torch&#39;</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">params_torch</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=.</span><span class="mi">2</span><span class="p">)</span>
<span class="n">objective</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
</pre></div>
</div>
<p>Note that the scene parameters are effectively duplicated: we represent them
once using Enoki arrays (<code class="docutils literal notranslate"><span class="pre">params</span></code>), and once using PyTorch arrays
(<code class="docutils literal notranslate"><span class="pre">params_torch</span></code>). To perform a differentiable rendering, the function
<a class="reference internal" href="../../generated/python_api.html#mitsuba.python.autodiff.render_torch" title="mitsuba.python.autodiff.render_torch"><code class="xref py py-func docutils literal notranslate"><span class="pre">render_torch()</span></code></a> requires that both are given
as arguments. Due to technical specifics of how PyTorch detects differentiable
parameters, it is furthermore necessary that <code class="docutils literal notranslate"><span class="pre">params_torch</span></code> is expanded into
a list of keyword arguments (<code class="docutils literal notranslate"><span class="pre">**params_torch</span></code>). The function then keeps both
representation in sync and creates an interface between the underlying
computation graphs.</p>
<p>The main optimization loop looks as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="c1"># Zero out gradients before each iteration</span>
    <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

    <span class="c1"># Perform a differentiable rendering of the scene</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">render_torch</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">unbiased</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">spp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">params_torch</span><span class="p">)</span>

    <span class="n">write_bitmap</span><span class="p">(</span><span class="s1">&#39;out_</span><span class="si">%03i</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">it</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">crop_size</span><span class="p">)</span>

    <span class="c1"># Objective: MSE between &#39;image&#39; and &#39;image_ref&#39;</span>
    <span class="n">ob_val</span> <span class="o">=</span> <span class="n">objective</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">image_ref</span><span class="p">)</span>

    <span class="c1"># Back-propagate errors to input parameters</span>
    <span class="n">ob_val</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

    <span class="c1"># Optimizer: take a gradient step</span>
    <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="c1"># Compare iterate against ground-truth value</span>
    <span class="n">err_ref</span> <span class="o">=</span> <span class="n">objective</span><span class="p">(</span><span class="n">params_torch</span><span class="p">[</span><span class="s1">&#39;red.reflectance.value&#39;</span><span class="p">],</span> <span class="n">param_ref</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Iteration </span><span class="si">%03i</span><span class="s1">: error=</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">err_ref</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Memory caching</strong>: When a GPU array in Enoki or PyTorch is destroyed, its
memory is not immediately released back to the GPU. The reason for this is
that allocating and releasing GPU memory are both extremely expensive
operations, and any unused memory is therefore instead placed into a cache
for later re-use.</p>
<p>The fact that this happens is normally irrelevant when <em>only</em> using Enoki
or <em>only</em> using PyTorch, but it can be a problem when using <em>both</em> at the
same time, as the cache of one system may grow sufficiently large that
allocations by the other system fail, despite plenty of free memory
technically being available.</p>
<p>If you notice that your programs crash with out-of-memory errors, try
passing <code class="docutils literal notranslate"><span class="pre">malloc_trim=True</span></code> to the <code class="docutils literal notranslate"><span class="pre">render_torch</span></code> function. This
flushes PyTorch’s memory cache before executing any Enoki code, and vice
versa. This is something of a last resort—generally, it’s better to
reduce memory requirements by lowering the number of samples per pixel,
as flushing the cache causes severe performance penalty.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The full Python script of this tutorial can be found in the file:
<code class="file docutils literal notranslate"><span class="pre">docs/examples/10_diff_render/invert_cbox_torch.py</span></code>.</p>
</div>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="advanced.html" title="previous chapter (use the left arrow)">More advanced examples</a>
      </div>
    
      <div class="pull-right">
        <a class="btn btn-default" href="../developer_guide/intro.html" title="next chapter (use the right arrow)">Introduction</a>
      </div>
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../developer_guide/intro.html" title="Introduction"
             >next</a> |</li>
        <li class="right" >
          <a href="advanced.html" title="More advanced examples"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">mitsuba2 0.1.dev0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Integration with PyTorch</a></li> 
      </ul>
    </div>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>

  </body>
</html>