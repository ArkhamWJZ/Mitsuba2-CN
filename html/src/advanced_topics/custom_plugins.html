<!-- Based on https://stackoverflow.com/a/25543713/1130282 -->

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../../_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="../../_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>在 Python 中自定义插件 &#8212; mitsuba2 0.1.dev0 documentation</title>
    <link rel="stylesheet" href="../../_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/theme_overrides.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Plugin reference" href="../plugin_reference/intro.html" />
    <link rel="prev" title="Polarization" href="../developer_guide/polarization.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../plugin_reference/intro.html" title="Plugin reference"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../developer_guide/polarization.html" title="Polarization"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">mitsuba2 0.1.dev0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">在 Python 中自定义插件</a></li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar"><a href="
    ../../index.html" class="text-logo">Mitsuba 2</a>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Table Of Contents</h2>
  </div>
  <div class="sidebar-toc">
    
    
      <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/intro.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/cloning.html">Cloning the repository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/variants.html">选择变体</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/compiling.html">Compiling the system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/file_format.html">Scene file format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/differences.html">Differences to Mitsuba 0.6</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/faq.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">Release notes</a></li>
</ul>
<p class="caption"><span class="caption-text">Python interface</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python_interface/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_interface/parsing_xml.html">Parsing XML code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_interface/rendering_scene.html">渲染场景</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python_interface/bsdf_eval.html">Custom applications</a></li>
</ul>
<p class="caption"><span class="caption-text">Inverse rendering</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../inverse_rendering/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inverse_rendering/diff_render.html">Differentiable rendering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inverse_rendering/advanced.html">More advanced examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inverse_rendering/pytorch.html">Integration with PyTorch</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/variants_cpp.html">Variants in C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/writing_plugin.html">Plugins &amp; Macros</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/debugging.html">Debug 调试</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/building_documentation.html">Building the documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer_guide/polarization.html">Polarization</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced topics</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">在 Python 中自定义插件</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#bsdf-example">BSDF example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#integrator-example">Integrator example</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Plugin reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../plugin_reference/intro.html">Plugin reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html">Shapes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#bsdfs">BSDFs 大大大</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#phase-functions">Phase functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#emitters">Emitters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#sensors">Sensors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#textures">Textures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#spectra">Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#integrators">Integrators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#samplers">Samplers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#films">Films</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/plugins.html#reconstruction-filters">Reconstruction filters</a></li>
</ul>
<p class="caption"><span class="caption-text">API reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_reference/intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/core_api.html">Core API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/render_api.html">Render API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generated/python_api.html">Python API Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">Miscellaneous</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../zz_bibliography.html">Bibliography</a></li>
</ul>

    
  </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="../../index.html">Docs</a></li>
              
              <li>在 Python 中自定义插件</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <div class="section" id="python">
<span id="sec-custom-plugins"></span><h1>在 Python 中自定义插件<a class="headerlink" href="#python" title="Permalink to this headline">¶</a></h1>
<p>Mitsuba 2提供了一种机制可以 <em>直接在 Python 中</em> 实现自定义插件。如需这么做，只需扩展一个基类（例如 <code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">BSDF</span></code>， <code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">Emitter</span></code>）
并且覆盖其类方法即可（例如，<code class="docutils literal notranslate"><span class="pre">sample()</span></code>， <code class="docutils literal notranslate"><span class="pre">eval()</span></code> 等）。这充分利用了 <em>pybind11</em> 的  <a class="reference external" href="https://pybind11.readthedocs.io/en/stable/advanced/classes.html#overriding-virtual-functions-in-python">trampoline feature</a> 特性。</p>
<p>随后可以通过调用 <code class="docutils literal notranslate"><span class="pre">register_&lt;type&gt;(name,</span> <span class="pre">constructor)</span></code> 函数向 XML 解析器中注册新的插件，使其可以像其他 C++ 插件一样
可以在 XML场景描述中随意访问。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>在使用 Python 实现系统的核心组件时，只有在 <code class="docutils literal notranslate"><span class="pre">gpu_*</span></code> 变体下才会有合理的性能表现（因为它们可以和其他系统组件一起
被 JIT 编译）。我们计划在未来将这一功能扩展到更多变体模式。</p>
<p>目前，在 Python 中只能实现 <code class="docutils literal notranslate"><span class="pre">BSDF</span></code>，<code class="docutils literal notranslate"><span class="pre">Emitter</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Integrator</span></code> 插件。</p>
</div>
<p>本章节的其余部分将讨论这几个插件的相应示例：</p>
<div class="section" id="bsdf-example">
<h2>BSDF example<a class="headerlink" href="#bsdf-example" title="Permalink to this headline">¶</a></h2>
<p>在本例中，我们将通过扩展 <code class="code docutils literal notranslate"><span class="pre">BSDF</span></code> 基类，在 Python 中实现一个简单的漫反射 BSDF。代码与 C++ 中实现的
漫反射 BSDF 非常相似（参见 <code class="code docutils literal notranslate"><span class="pre">src/bsdf/diffuse.cpp</span></code>）。</p>
<p>BSDF 类需要实现以下三个方法：<code class="code docutils literal notranslate"><span class="pre">sample</span></code>，<code class="code docutils literal notranslate"><span class="pre">eval</span></code> 和 <code class="code docutils literal notranslate"><span class="pre">pdf</span></code>：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyDiffuseBSDF</span><span class="p">(</span><span class="n">BSDF</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">):</span>
        <span class="n">BSDF</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_reflectance</span> \
            <span class="o">=</span> <span class="n">load_string</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;&lt;spectrum version=&#39;2.0.0&#39; type=&#39;srgb&#39; name=&quot;reflectance&quot;&gt;</span>
<span class="s1">                                &lt;rgb name=&quot;color&quot; value=&quot;0.45, 0.90, 0.90&quot;/&gt;</span>
<span class="s1">                             &lt;/spectrum&gt;&#39;&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_flags</span> <span class="o">=</span> <span class="n">BSDFFlags</span><span class="o">.</span><span class="n">DiffuseReflection</span> <span class="o">|</span> <span class="n">BSDFFlags</span><span class="o">.</span><span class="n">FrontSide</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_components</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">m_flags</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">sample1</span><span class="p">,</span> <span class="n">sample2</span><span class="p">,</span> <span class="n">active</span><span class="p">):</span>
        <span class="n">cos_theta_i</span> <span class="o">=</span> <span class="n">Frame3f</span><span class="o">.</span><span class="n">cos_theta</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span>

        <span class="n">active</span> <span class="o">&amp;=</span> <span class="n">cos_theta_i</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="n">bs</span> <span class="o">=</span> <span class="n">BSDFSample3f</span><span class="p">()</span>
        <span class="n">bs</span><span class="o">.</span><span class="n">wo</span>  <span class="o">=</span> <span class="n">warp</span><span class="o">.</span><span class="n">square_to_cosine_hemisphere</span><span class="p">(</span><span class="n">sample2</span><span class="p">)</span>
        <span class="n">bs</span><span class="o">.</span><span class="n">pdf</span> <span class="o">=</span> <span class="n">warp</span><span class="o">.</span><span class="n">square_to_cosine_hemisphere_pdf</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">wo</span><span class="p">)</span>
        <span class="n">bs</span><span class="o">.</span><span class="n">eta</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">bs</span><span class="o">.</span><span class="n">sampled_type</span> <span class="o">=</span> <span class="o">+</span><span class="n">BSDFFlags</span><span class="o">.</span><span class="n">DiffuseReflection</span>
        <span class="n">bs</span><span class="o">.</span><span class="n">sampled_component</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_reflectance</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">active</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span> <span class="n">bs</span><span class="p">,</span> <span class="n">ek</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">active</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">pdf</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">value</span><span class="p">,</span> <span class="n">Vector3f</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">wo</span><span class="p">,</span> <span class="n">active</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ctx</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">(</span><span class="n">BSDFFlags</span><span class="o">.</span><span class="n">DiffuseReflection</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Vector3f</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">cos_theta_i</span> <span class="o">=</span> <span class="n">Frame3f</span><span class="o">.</span><span class="n">cos_theta</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span>
        <span class="n">cos_theta_o</span> <span class="o">=</span> <span class="n">Frame3f</span><span class="o">.</span><span class="n">cos_theta</span><span class="p">(</span><span class="n">wo</span><span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_reflectance</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">active</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">InvPi</span> <span class="o">*</span> <span class="n">cos_theta_o</span>

        <span class="k">return</span> <span class="n">ek</span><span class="o">.</span><span class="n">select</span><span class="p">((</span><span class="n">cos_theta_i</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cos_theta_o</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">value</span><span class="p">,</span> <span class="n">Vector3f</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">wo</span><span class="p">,</span> <span class="n">active</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ctx</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">(</span><span class="n">BSDFFlags</span><span class="o">.</span><span class="n">DiffuseReflection</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Vector3f</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">cos_theta_i</span> <span class="o">=</span> <span class="n">Frame3f</span><span class="o">.</span><span class="n">cos_theta</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">wi</span><span class="p">)</span>
        <span class="n">cos_theta_o</span> <span class="o">=</span> <span class="n">Frame3f</span><span class="o">.</span><span class="n">cos_theta</span><span class="p">(</span><span class="n">wo</span><span class="p">)</span>

        <span class="n">pdf</span> <span class="o">=</span> <span class="n">warp</span><span class="o">.</span><span class="n">square_to_cosine_hemisphere_pdf</span><span class="p">(</span><span class="n">wo</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ek</span><span class="o">.</span><span class="n">select</span><span class="p">((</span><span class="n">cos_theta_i</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cos_theta_o</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">pdf</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;MyDiffuseBSDF[reflectance = </span><span class="si">%s</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m_reflectance</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

</pre></div>
</div>
<p>在定义这个新的 BSDF 类之后，我们需要将其注册为插件。这会允许 Mitsuba 在加载场景时实例化这个新的 BSDF：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">register_bsdf</span><span class="p">(</span><span class="s2">&quot;mydiffusebsdf&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">props</span><span class="p">:</span> <span class="n">MyDiffuseBSDF</span><span class="p">(</span><span class="n">props</span><span class="p">))</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">register_bsdf</span></code> 函数接收新插件的名称和构造新实例的函数。在这之后，我们就可以在 XML 场景文件中使用
我们自定义的 BSDF 了。</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;bsdf</span> <span class="na">type=</span><span class="s">&quot;mydiffusebsdf&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<p>随后可以通过调用标准函数 <code class="code docutils literal notranslate"><span class="pre">render</span></code> 来进行渲染场景：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load an XML file which specifies &quot;mydiffusebsdf&quot; as material</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;path/to/my/scene.xml&#39;</span>
<span class="n">Thread</span><span class="o">.</span><span class="n">thread</span><span class="p">()</span><span class="o">.</span><span class="n">file_resolver</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
<span class="n">scene</span> <span class="o">=</span> <span class="n">load_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="n">scene</span><span class="o">.</span><span class="n">integrator</span><span class="p">()</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">scene</span><span class="o">.</span><span class="n">sensors</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">film</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">sensors</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">film</span><span class="p">()</span>
<span class="n">film</span><span class="o">.</span><span class="n">set_destination_file</span><span class="p">(</span><span class="s1">&#39;my-diffuse-bsdf.exr&#39;</span><span class="p">)</span>
<span class="n">film</span><span class="o">.</span><span class="n">develop</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The code for this example can be found in <code class="code docutils literal notranslate"><span class="pre">docs/examples/04_diffuse_bsdf/diffuse_bsdf.py</span></code></p>
</div>
</div>
<div class="section" id="integrator-example">
<h2>Integrator example<a class="headerlink" href="#integrator-example" title="Permalink to this headline">¶</a></h2>
<p>在本例中，我们将通过相同的机制实现自定义的直接光照集成器。生成的图像将具有逼真的阴影和着色，但是没有全局照明。</p>
<p>渲染的主要过程可以由大约30行代码实现：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">integrator_sample</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="n">rays</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">si</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">ray_intersect</span><span class="p">(</span><span class="n">rays</span><span class="p">)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">active</span>

    <span class="c1"># Visible emitters</span>
    <span class="n">emitter_vis</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">emitter</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">active</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">ek</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">Emitter</span><span class="o">.</span><span class="n">eval_vec</span><span class="p">(</span><span class="n">emitter_vis</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">active</span><span class="p">),</span> <span class="n">Vector3f</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">BSDFContext</span><span class="p">()</span>
    <span class="n">bsdf</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">bsdf</span><span class="p">(</span><span class="n">rays</span><span class="p">)</span>

    <span class="c1"># Emitter sampling</span>
    <span class="n">sample_emitter</span> <span class="o">=</span> <span class="n">active</span> <span class="o">&amp;</span> <span class="n">has_flag</span><span class="p">(</span><span class="n">BSDF</span><span class="o">.</span><span class="n">flags_vec</span><span class="p">(</span><span class="n">bsdf</span><span class="p">),</span> <span class="n">BSDFFlags</span><span class="o">.</span><span class="n">Smooth</span><span class="p">)</span>
    <span class="n">ds</span><span class="p">,</span> <span class="n">emitter_val</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">sample_emitter_direction</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">sampler</span><span class="o">.</span><span class="n">next_2d</span><span class="p">(</span><span class="n">sample_emitter</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">sample_emitter</span><span class="p">)</span>
    <span class="n">active_e</span> <span class="o">=</span> <span class="n">sample_emitter</span> <span class="o">&amp;</span> <span class="n">ek</span><span class="o">.</span><span class="n">neq</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">pdf</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">wo</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">to_local</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
    <span class="n">bsdf_val</span> <span class="o">=</span> <span class="n">BSDF</span><span class="o">.</span><span class="n">eval_vec</span><span class="p">(</span><span class="n">bsdf</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">wo</span><span class="p">,</span> <span class="n">active_e</span><span class="p">)</span>
    <span class="n">bsdf_pdf</span> <span class="o">=</span> <span class="n">BSDF</span><span class="o">.</span><span class="n">pdf_vec</span><span class="p">(</span><span class="n">bsdf</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">wo</span><span class="p">,</span> <span class="n">active_e</span><span class="p">)</span>
    <span class="n">mis</span> <span class="o">=</span> <span class="n">ek</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="n">Float</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">mis_weight</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">pdf</span><span class="p">,</span> <span class="n">bsdf_pdf</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">+=</span> <span class="n">ek</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">active_e</span><span class="p">,</span> <span class="n">emitter_val</span> <span class="o">*</span> <span class="n">bsdf_val</span> <span class="o">*</span> <span class="n">mis</span><span class="p">,</span> <span class="n">Vector3f</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="c1"># BSDF sampling</span>
    <span class="n">active_b</span> <span class="o">=</span> <span class="n">active</span>
    <span class="n">bs</span><span class="p">,</span> <span class="n">bsdf_val</span> <span class="o">=</span> <span class="n">BSDF</span><span class="o">.</span><span class="n">sample_vec</span><span class="p">(</span><span class="n">bsdf</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">sampler</span><span class="o">.</span><span class="n">next_1d</span><span class="p">(</span><span class="n">active</span><span class="p">),</span> <span class="n">sampler</span><span class="o">.</span><span class="n">next_2d</span><span class="p">(</span><span class="n">active</span><span class="p">),</span> <span class="n">active_b</span><span class="p">)</span>
    <span class="n">si_bsdf</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">ray_intersect</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">spawn_ray</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">to_world</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">wo</span><span class="p">)),</span> <span class="n">active_b</span><span class="p">)</span>
    <span class="n">emitter</span> <span class="o">=</span> <span class="n">si_bsdf</span><span class="o">.</span><span class="n">emitter</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">active_b</span><span class="p">)</span>
    <span class="n">active_b</span> <span class="o">&amp;=</span> <span class="n">ek</span><span class="o">.</span><span class="n">neq</span><span class="p">(</span><span class="n">emitter</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">emitter_val</span> <span class="o">=</span> <span class="n">Emitter</span><span class="o">.</span><span class="n">eval_vec</span><span class="p">(</span><span class="n">emitter</span><span class="p">,</span> <span class="n">si_bsdf</span><span class="p">,</span> <span class="n">active_b</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">has_flag</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">sampled_type</span><span class="p">,</span> <span class="n">BSDFFlags</span><span class="o">.</span><span class="n">Delta</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">DirectionSample3f</span><span class="p">(</span><span class="n">si_bsdf</span><span class="p">,</span> <span class="n">si</span><span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">object</span> <span class="o">=</span> <span class="n">emitter</span>
    <span class="n">emitter_pdf</span> <span class="o">=</span> <span class="n">ek</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">Float</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">scene</span><span class="o">.</span><span class="n">pdf_emitter_direction</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">active_b</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">+=</span> <span class="n">ek</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">active_b</span><span class="p">,</span> <span class="n">bsdf_val</span> <span class="o">*</span> <span class="n">emitter_val</span> <span class="o">*</span> <span class="n">mis_weight</span><span class="p">(</span><span class="n">bs</span><span class="o">.</span><span class="n">pdf</span><span class="p">,</span> <span class="n">emitter_pdf</span><span class="p">),</span> <span class="n">Vector3f</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">si</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(),</span> <span class="n">ek</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(),</span> <span class="n">si</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">Float</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
</pre></div>
</div>
<p>代码与 C++ 代码实现的直接光照集成器非常相似（参见 <code class="code docutils literal notranslate"><span class="pre">src/integrators/direct.cpp</span></code>）。
该函数将当前场景、采样器和光线数组当作参数。<code class="code docutils literal notranslate"><span class="pre">active</span></code> 参数指定了哪些通道是被激活的。</p>
<p>我们首先将提供的光线与场景求交，并估算发光体的直接光强。随后，我们在发光体上显式采样位置，并估算它们的贡献。
随后我们根据 BSDF 采样光线方向，并计算这些光线是否击中了其他发光体。接着通过多重重要性采样将这些贡献组合在
一起以减少方差。</p>
<p>此函数将针对不同的光线序列进行调用，因为每条光线都有可能击中具有不同 BSDF 的曲面。因此 <code class="code docutils literal notranslate"><span class="pre">bsdf</span> <span class="pre">=</span> <span class="pre">si.bsdf(rays)</span></code>
是一个由不同的 BSDF 指针组成的数组。为了调用这些不同 BSDF 的成员函数，我们通过矢量化方法调用这些特殊的分派函数：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">bsdf_val</span> <span class="o">=</span> <span class="n">BSDF</span><span class="o">.</span><span class="n">eval_vec</span><span class="p">(</span><span class="n">bsdf</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">wo</span><span class="p">,</span> <span class="n">active_e</span><span class="p">)</span>
    <span class="n">bsdf_pdf</span> <span class="o">=</span> <span class="n">BSDF</span><span class="o">.</span><span class="n">pdf_vec</span><span class="p">(</span><span class="n">bsdf</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">wo</span><span class="p">,</span> <span class="n">active_e</span><span class="p">)</span>
</pre></div>
</div>
<p>这确保每个变体都能正确调用由 C++ 或 Python 实现的 BSDF 模型。除此之外，代码和使用的接口与 C++ 版本有关。
请参阅有关 C++ 类型的文档，以获得更多关于函数和对象的信息。</p>
<p>当在 <a class="reference internal" href="../python_interface/rendering_scene.html#sec-rendering-scene-custom"><span class="std std-ref">custom rendering pipelines</span></a> 这一章节实现深度集成器时，
如要正确的从相机中采样光线和实现胶片的 “飞溅” 需要耗费大量的工作。虽然这对某些程序来说非常有用，但是也有些单调乏味。
许多情况下我们只需要实现一个自定义的集成器，并不需要考虑光线是如何准确生成的。因此，在本例中我们将使用一种更为优雅的
机制，它允许简单的扩展 <code class="code docutils literal notranslate"><span class="pre">SamplingIntegrator</span></code> 基类。这个类是所有蒙特卡洛积分器的基类（例如，路径追踪器）。
通过这个类来定义我们的积分器，随后我们可以依赖 Mitsuba 的现有机制来正确的实现相机光线采样和像素值“飞溅”。</p>
<p>由于我们已经使用正确的接口定义了函数 <code class="code docutils literal notranslate"><span class="pre">integrator_sample</span></code>，因此定义一个新的积分器是非常简单的：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyDirectIntegrator</span><span class="p">(</span><span class="n">SamplingIntegrator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">):</span>
        <span class="n">SamplingIntegrator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">active</span><span class="p">):</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">is_valid</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">integrator_sample</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="n">ray</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">active</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">is_valid</span><span class="p">,</span> <span class="p">[</span><span class="n">depth</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">aov_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;depth.Y&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;MyDirectIntegrator[]&quot;</span>
</pre></div>
</div>
<p>该积分器不仅返回颜色值，而且还会额外渲染出场景深度。当使用此积分器时，Mitsuba 将输出额外带有一个深度通道的多通
道 EXR 文件。 <code class="code docutils literal notranslate"><span class="pre">aov_names</span></code> 方法将用于命名任意输出变量（AOVs）。例如，可以使用相同的机制来输出曲面法线。
如果不需要 AOV，只需要返回一个空列表。</p>
<p>在定义一个新的积分器类之后，我们必须将其注册为插件。这允许 Mitsuba 在加载场景时实例化这个新的积分器：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">register_integrator</span><span class="p">(</span><span class="s2">&quot;mydirectintegrator&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">props</span><span class="p">:</span> <span class="n">MyDirectIntegrator</span><span class="p">(</span><span class="n">props</span><span class="p">))</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">register_integrator</span></code> 函数接受新的插件名称和新实例的构造函数。随后，我们就可以在场景中使用指定的新积分器：</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;integrator</span> <span class="na">type=</span><span class="s">&quot;mydirectintegrator&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<p>然后可以通过标准 <code class="code docutils literal notranslate"><span class="pre">render</span></code> 函数渲染场景了：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load an XML file which specifies &quot;mydirectintegrator&quot; as the scene&#39;s integrator</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;path/to/my/scene.xml&#39;</span>
<span class="n">Thread</span><span class="o">.</span><span class="n">thread</span><span class="p">()</span><span class="o">.</span><span class="n">file_resolver</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
<span class="n">scene</span> <span class="o">=</span> <span class="n">load_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="n">scene</span><span class="o">.</span><span class="n">integrator</span><span class="p">()</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">scene</span><span class="o">.</span><span class="n">sensors</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">film</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">sensors</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">film</span><span class="p">()</span>
<span class="n">film</span><span class="o">.</span><span class="n">set_destination_file</span><span class="p">(</span><span class="s1">&#39;my-direct-integrator.exr&#39;</span><span class="p">)</span>
<span class="n">film</span><span class="o">.</span><span class="n">develop</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>此示例代码可以在 <code class="code docutils literal notranslate"><span class="pre">docs/examples/03_direct_integrator/direct_integrator.py</span></code> 中找到。</p>
</div>
</div>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="../developer_guide/polarization.html" title="previous chapter (use the left arrow)">Polarization</a>
      </div>
    
      <div class="pull-right">
        <a class="btn btn-default" href="../plugin_reference/intro.html" title="next chapter (use the right arrow)">Plugin reference</a>
      </div>
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../plugin_reference/intro.html" title="Plugin reference"
             >next</a> |</li>
        <li class="right" >
          <a href="../developer_guide/polarization.html" title="Polarization"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">mitsuba2 0.1.dev0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">在 Python 中自定义插件</a></li> 
      </ul>
    </div>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>

  </body>
</html>